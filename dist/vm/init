#!/bin/bash -x

while true; do
        /usr/bin/curl -s http://169.254.169.254/latest/meta-data/hostname -o /etc/hostname
        if [ "$?" == "0" ]; then
                break
        fi
        sleep 1
done
/usr/bin/hostname -F /etc/hostname
export HOSTNAME=`/usr/bin/hostname`

while true; do
        /usr/bin/curl -s http://169.254.169.254/latest/user-data -o /allspark/env.sh
        if [ "$?" == "0" ]; then
                break
        fi
        sleep 1
done

source /allspark/env.sh

if [ ! -z $MASTER_IP ]; then
        mount $MASTER_IP:/shared /shared
fi
docker run -d --log-driver journal --ulimit nofile=122880:122880 --env-file /allspark/env.sh --network host --mount type=bind,source=/shared,target=/shared allspark-worker:latest
tail -f /dev/null
