#!/bin/bash -x

function set_env_variables {
        META_URL="http://169.254.169.254/metadata/instance?api-version=2019-06-01"
        curl -s -H Metadata:true --noproxy "*" $META_URL | jq '.compute.tags' | sed -e 's/"//g' | python3 /allspark/write_env.py
        source /allspark/env.sh
}

function mount_shared_volume {
        if [ ! -z $MASTER_IP ]; then
                mount $MASTER_IP:/shared /shared
        fi
}

function run_allspark_image {-
        docker run -d --log-driver syslog --ulimit nofile=122880:122880 --env-file /allspark/env.sh --network host --mount type=bind,source=/shared,target=/shared allspark-worker:latest
        tail -f /dev/null
}

set_env_variables
mount_shared_volume
run_allspark_image
