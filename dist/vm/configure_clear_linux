#!/bin/bash -ex

function clean_up {
    rm /var/lib/cloud/*
    rm -Rf /allspark/allspark-orchestrator
}

function enable_services {
    systemctl start docker
    systemctl enable docker

    systemctl enable rpcbind
    systemctl start rpcbind

    systemctl start nfs-server
    systemctl enable nfs-server

    systemctl enable allspark
}

function configure_allspark {
    mkdir /shared
    chmod 777 /shared

    mkdir /allspark
    cd /allspark 
    git clone https://github.com/macrobytes/allspark-orchestrator.git
    DATA_PATH="/allspark/allspark-orchestrator/dist/vm"
    
    cp $DATA_PATH/allspark.service /usr/lib/systemd/system
    cp $DATA_PATH/exports /etc/exports
    cp $DATA_PATH/init /allspark
    cp $DATA_PATH/patch_allspark /allspark

    chmod +x /allspark/init
    chmod +x /allspark/patch_allspark
}

function install_bundles {
    swupd bundle-add cloud-control \
        bootloader \
        cloud-api \
        cloud-control \
        clr-network-troubleshooter \
        curl \
        diffutils \
        dpdk \
        ethtool \
        findutils \
        git \
        iproute2 \
        iptables \
        jq \
        kernel-aws \
        kvm-host \
        less \
        lib-opengl \
        lib-openssl \
        libX11client \
        libglib \
        libstdcpp \
        linux-firmware-wifi \
        net-tools \
        network-basic \
        nfs-utils \
        openldap \
        openssh-server \
        openssl \
        openvswitch \
        os-cloudguest-aws \
        os-core \
        os-core-update \
        os-core-webproxy \
        p11-kit \
        perl-basic \
        polkit \
        python3-basic \
        sqlite \
        syslinux \
        systemd-networkd-autostart \
        tmux \
        unzip \
        vim \
        wget \
        which \
        wpa_supplicant \
        znc
}

install_bundles
swupd update
configure_allspark
enable_services
clean_up
