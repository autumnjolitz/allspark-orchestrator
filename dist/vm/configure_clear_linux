#!/bin/bash -ex

function clean_up {
    rm -Rf /allspark/allspark-orchestrator
    rm /allspark/spark-2.4.4-bin-hadoop2.7.tgz
    rm /allspark/sparkling-water-2.4.13.zip
    rm /allspark/rm zulu8.40.0.25-ca-jdk8.0.222-linux_x64.tar.gz
}

function enable_services {
    systemctl enable allspark
    systemctl enable rpc-bind
    systemctl enable nfs-server
}

function install_ml_tools {
    wget https://www.apache.org/dist/spark/spark-2.4.4/spark-2.4.4-bin-hadoop2.7.tgz
    tar -xf spark-2.4.4-bin-hadoop2.7.tgz

    wget https://s3.amazonaws.com/h2o-release/sparkling-water/rel-2.4/13/sparkling-water-2.4.13.zip
    unzip sparkling-water-2.4.13.zip

    wget https://cdn.azul.com/zulu/bin/zulu8.40.0.25-ca-jdk8.0.222-linux_x64.tar.gz
    tar -xvf zulu8.40.0.25-ca-jdk8.0.222-linux_x64.tar.gz
}

function configure_allspark {
    sudo mkdir /shared
    chmod 777 /shared

    sudo mkdir /allspark
    cd /allspark 
    git clone https://github.com/macrobytes/allspark-orchestrator.git
    DATA_PATH="/allspark/allspark-orchestrator/dist/vm"
    
    pip install -r $DATA_PATH/requirements.txt
    cp $DATA_PATH/allspark.service /usr/lib/systemd/system
    cp $DATA_PATH/exports /usr/lib/systemd/exports
    cp $DATA_PATH/init /allspark
    cp $DATA_PATH/run /allspark
    cp $DATA_PATH/run_monitor.py /allspark

    chmod +x /allspark/run_monitor.py
    chmod +x /allspark/run
    chmod +x /allspark/init
}

function install_bundles {
    swupd bundle-add bootloader \
        cloud-api \
        cloud-control \
        clr-network-troubleshooter \
        curl \
        diffutils \
        dpdk \
        ethtool \
        findutils \
        git \
        iproute2 \
        iptables \
        jq \
        kernel-aws \
        kvm-host \
        less \
        lib-opengl \
        lib-openssl \
        libX11client \
        libglib \
        libstdcpp \
        linux-firmware-wifi \
        net-tools \
        network-basic \
        nfs-utils \
        openldap \
        openssh-server \
        openssl \
        openvswitch \
        os-cloudguest-aws \
        os-core \
        os-core-update \
        os-core-webproxy \
        p11-kit \
        perl-basic \
        polkit \
        python3-basic \
        sqlite \
        sudo \
        syslinux \
        systemd-networkd-autostart \
        tmux \
        unzip \
        vim \
        wget \
        which \
        wpa_supplicant \
        znc
}

install_bundles
configure_allspark
install_ml_tools
clean_up
